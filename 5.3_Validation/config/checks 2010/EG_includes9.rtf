{\rtf1\ansi\ansicpg1252\deff0\deflang2057{\fonttbl{\f0\fnil Courier New;}{\f1\fswiss\fcharset0 Arial;}}
{\colortbl ;\red0\green128\blue0;\red0\green0\blue0;\red0\green0\blue255;\red0\green0\blue128;\red128\green0\blue128;\red0\green128\blue128;}
{\*\generator Msftedit 5.41.15.1515;}\viewkind4\uc1\pard\cf1\f0\fs20 * INCLUDES9.SAS;\cf2\par
\par
\cf3 %let\cf2  yy=\cf3 %substr\cf2 (&RYYYY,3,2);\par
\cf3 %let\cf2  ss=%lowcase(&RCL);\par
\par
\cf1 /*--------------------------------------*/\cf2\par
\par
\cf3 %let\cf2  eusilc=/ec/prod/server/sas/0eusilc/main;\par
\par
\cf3 options\cf2  source nosource2 notes;\par
\par
\cf3 %let\cf2  csv=&eusilc/params;\par
\par
\par
\cf1 *** create parameter files ***;\cf2  \par
\cf4\b %MACRO\cf2\b0  frmts(f);\par
\par
\cf1 /*source file*/\cf2\par
filename parfile \cf5 "&csv/checks 20&yy/_par&ss&yy._s.csv"\cf2 ; \cf1 *** variables parameter file;\cf2   \par
\cf1 /*output files*/\cf2\par
filename frmfile \cf5 "&eusilc/pgm/&ss&yy&f.format.0sas"\cf2 ;  \cf1 *** definition of variable formats;\cf2  \par
filename varfile \cf5 "&eusilc/pgm/&ss&yy&f.var.0sas"\cf2 ;  \cf1 *** definition of variables list;\cf2  \par
\par
\cf1 /* create format file &ss&yy&f.format.0sas */\cf2\par
\par
DATA _null_;\par
  length vars \cf6 $2000.\cf2 ;\par
  retain vars;\par
\tab\cf1 /*input file*/\cf2\par
  infile parfile MISSOVER DSD LRECL=\cf6\b 2048\cf2\b0  firstobs=\cf6\b 2\cf2\b0  end=fin TERMSTR=CRLF;\par
\tab\cf1 /*output file*/\cf2\par
\tab file frmfile;\par
  format varnam \cf6 $8.\cf2 ;\par
  format vformat \cf6 $8.\cf2 ;\par
  length txt \cf6 $256.\cf2 ;\par
  input varnam req vformat;\par
  if lowcase(substr(varnam,\cf6\b 1\cf2\b0 ,\cf6\b 1\cf2\b0 )) = \cf5 "&f"\cf2  \par
  or (substr(varnam,\cf6\b 1\cf2\b0 ,\cf6\b 2\cf2\b0 ) = \cf5 "MH"\cf2  and \cf5 "&f"\cf2  = \cf5 "h"\cf2 ) \par
  or (substr(varnam,\cf6\b 1\cf2\b0 ,\cf6\b 2\cf2\b0 ) = \cf5 "MI"\cf2  and \cf5 "&f"\cf2  = \cf5 "h"\cf2 ) then\par
  do; \par
    txt = \cf5 "format "\cf2 ||compress(varnam)||\cf5 " "\cf2 ||substr(vformat,\cf6\b 2\cf2\b0 )||\cf5 ";"\cf2 ;\par
\tab put txt;\par
\tab if not req then \par
\tab do;\par
\tab\tab txt = compress(varnam)||\cf5 " = .;"\cf2 ;\par
\tab  \tab put txt;\par
\tab end;\par
  \tab vars = trim(vars) || \cf5 " "\cf2  || compress(varnam);\par
\tab if substr(vformat,\cf6\b 1\cf2\b0 ,\cf6\b 1\cf2\b0 ) = \cf5 "f"\cf2  then\par
\tab do;\par
\tab   txt = \cf5 "format "\cf2 ||compress(varnam)||\cf5 "_F 2.;"\cf2 ;\par
\tab   put txt;\par
      if not req then \par
\tab   do;\par
\tab\tab txt = compress(varnam)||\cf5 "_F = .;"\cf2 ;\par
\tab  \tab put txt;\par
\tab   end;\par
      vars = trim(vars) || \cf5 " "\cf2  || compress(varnam)|| \cf5 "_F"\cf2 ;\par
\tab end;\par
\tab if substr(vformat,\cf6\b 1\cf2\b0 ,\cf6\b 1\cf2\b0 ) = \cf5 "i"\cf2  then\par
\tab do;\par
\tab   txt = \cf5 "format "\cf2 ||compress(varnam)||\cf5 "_F $12.;"\cf2 ;\par
\tab   put txt;\par
      vars = trim(vars) || \cf5 " "\cf2  || compress(varnam)|| \cf5 "_F"\cf2 ;\par
\tab   txt = \cf5 "format "\cf2 ||compress(varnam)||\cf5 "_FF 2.;"\cf2 ;\par
\tab   put txt;\par
\tab   txt = compress(varnam)||\cf5 "_FF = .;"\cf2 ;\par
\tab   put txt;\par
\tab   txt = \cf5 "format "\cf2 ||compress(varnam)||\cf5 "_I 9.5;"\cf2 ;\par
\tab   put txt;\par
\tab   txt = compress(varnam)||\cf5 "_I = .;"\cf2 ;\par
\tab   put txt;\par
\tab   txt = \cf5 "rename "\cf2 ||compress(varnam)||\cf5 "_F = "\cf2 ||compress(varnam)||\cf5 "_FI;"\cf2 ;\par
\tab   put txt;\par
\tab   txt = \cf5 "rename "\cf2 ||compress(varnam)||\cf5 "_FF = "\cf2 ||compress(varnam)||\cf5 "_F;"\cf2 ;\par
\tab   put txt;\par
      if not req then \par
\tab   do;\par
\tab\tab txt = compress(varnam)||\cf5 "_F = .;"\cf2 ;\par
\tab  \tab put txt;\par
\tab   end;\par
\tab end;\par
  end;\par
  if fin then\par
  do;\par
    file varfile lrecl=\cf6\b 2000\cf2\b0 ;\par
    put \cf5 "%nrstr(%let) vars="\cf2 ;\par
\tab put vars;\par
\tab put \cf5 ";"\cf2 ;\par
  end;\par
RUN;\par
\cf4\b %MEND\cf2\b0  frmts;\par
\par
\cf4\b %MACRO\cf2\b0  sntx(f);\par
filename chkfile  \cf5 "&eusilc/pgm/&ss&yy&f.chk.0sas"\cf2  lrecl=\cf6\b 310\cf2\b0 ;\par
filename parfile \cf5 "&csv/checks 20&yy/_par&ss&yy._s.csv"\cf2 ; \cf1 *** variables parameter file;\cf2   \par
\par
filename pl120r \cf5 "&csv/checks 20&yy/_PL120_r.sql"\cf2 ; \cf1 *** routing code PL120;\cf2\par
\par
\cf3 %if\cf2  &f=d or &f=h \cf3 %then\cf2  \cf3 %let\cf2  id=HID;\par
\cf3 %else\cf2  \cf3 %let\cf2  id=PID;           \par
\par
DATA _null_; \par
  infile parfile MISSOVER DSD LRECL=\cf6\b 2048\cf2\b0  firstobs=\cf6\b 2\cf2\b0  end=fin TERMSTR=CRLF;\par
  format varnam \cf6 $8.\cf2 ;\par
  format formt \cf6 $8.\cf2 ;\par
  format minval \cf6 $350.\cf2 ;\par
  format maxval \cf6 $256.\cf2 ;\par
  format flag \cf6 $256.\cf2 ;\par
  format conditio \cf6 $100.\cf2 ;\par
  format disp \cf6 $35.\cf2 ;\par
  format labl \cf6 $200.\cf2 ;\par
  input varnam req formt minval maxval flag conditio disp labl;\par
\par
  file chkfile;\par
  length txt1 $\cf6\b 256\cf2\b0 ;\par
  length txt2 $\cf6\b 350\cf2\b0 ;\par
  length txt2f $\cf6\b 350\cf2\b0 ;\par
  length txt3 $\cf6\b 256\cf2\b0 ;\par
  length txt30 $\cf6\b 256\cf2\b0 ;\par
  length txt4 $\cf6\b 256\cf2\b0 ;\par
  length txt5 $\cf6\b 256\cf2\b0 ;\par
\par
  if _N_= \cf6\b 1\cf2\b0  then do;\par
    put \cf5 "PROC SQL;"\cf2 ;\par
  \tab put \cf5 "Create table &ss%nrstr(&cc).&yy&f as select * from dds.&ss%nrstr(&cc).&yy&f ;"\cf2 ;\par
\tab put \cf5 "QUIT;"\cf2 ;\par
    put \cf5 "*----------------------------------------------------------------;"\cf2 ;\par
  end;\par
\par
  if lowcase(substr(varnam,\cf6\b 1\cf2\b0 ,\cf6\b 1\cf2\b0 )) = \cf5 "&f"\cf2  \par
  or (substr(varnam,\cf6\b 1\cf2\b0 ,\cf6\b 2\cf2\b0 ) = \cf5 "MH"\cf2  and \cf5 "&f"\cf2  = \cf5 "h"\cf2 ) \par
  or (substr(varnam,\cf6\b 1\cf2\b0 ,\cf6\b 2\cf2\b0 ) = \cf5 "MI"\cf2  and \cf5 "&f"\cf2  = \cf5 "h"\cf2 ) then\par
  do;\par
  if maxval in (\cf5 "country"\cf2 ) then\par
    txt1 = \cf5 "select &f.B010 ""Year"", &f.B030 ""&id"", "\cf2 ||trim(varnam)||\cf5 " from &ss%nrstr(&cc).&yy&f"\cf2 ;\par
  else if maxval in (\cf5 "hid"\cf2 ,\cf5 "pid"\cf2 ) then\par
    txt1 = \cf5 "select &f.B010 ""Year"", "\cf2 ||trim(varnam)||\cf5 " from &ss%nrstr(&cc).&yy&f"\cf2 ;\par
  else if substr(varnam,\cf6\b 2\cf2\b0 ,\cf6\b 4\cf2\b0 ) = \cf5 "B010"\cf2  then \par
    txt1 = \cf5 "select &f.B010 ""Year"", &f.B030 ""&id"" from &ss%nrstr(&cc).&yy&f"\cf2 ;\par
  else \par
    txt1 = \cf5 "select &f.B010 ""Year"", &f.B030 ""&id"", "\cf2 ||trim(varnam)||\cf5 ", "\cf2 ||trim(varnam)||\cf5 "_F from &ss%nrstr(&cc).&yy&f"\cf2 ;\par
\cf1 /* c:maxval="year", l:"B010" then maxval = also "year" for following tests */\cf2\par
  if maxval = \cf5 "year"\cf2  then \par
    txt2 = \cf5 "where "\cf2 ||trim(varnam)||\cf5 " not = "\cf2 ||trim(minval);  \par
  else if substr(varnam,\cf6\b 2\cf2\b0 ,\cf6\b 4\cf2\b0 ) = \cf5 "B010"\cf2  then do;\par
    txt2 = \cf5 "where ("\cf2 ||trim(varnam)||\cf5 " not between "\cf2 ||trim(minval)||\cf5 " and "\cf2 ||trim(maxval)||\cf5 ")"\cf2 ;  \par
\tab maxval = \cf5 "year"\cf2 ;\par
\tab end;\par
  else if maxval = \cf5 "country"\cf2  then\par
    txt2 = \cf5 "where "\cf2 ||trim(varnam)||\cf5 " not = %nrstr(%upcase)(""%nrstr(&cc)"")"\cf2 ;\par
  else if maxval = \cf5 "hid"\cf2  and \cf5 "&ss"\cf2  = \cf5 "c"\cf2  then\par
    txt2 = \cf5 "where "\cf2 ||trim(varnam)||\cf5 " not between 1 and 999999"\cf2 ;  \par
  else if maxval = \cf5 "hid"\cf2  and \cf5 "&ss"\cf2  = \cf5 "l"\cf2  then\par
    txt2 = \cf5 "where "\cf2 ||trim(varnam)||\cf5 " not between 100 and 99999999"\cf2 ;  \par
  else if maxval = \cf5 "pid"\cf2  and \cf5 "&ss"\cf2  = \cf5 "c"\cf2  then\par
    txt2 = \cf5 "where "\cf2 ||trim(varnam)||\cf5 " not between 101 and 99999999"\cf2 ;                        \par
  else if maxval = \cf5 "pid"\cf2  and \cf5 "&ss"\cf2  = \cf5 "l"\cf2  then\par
    txt2 = \cf5 "where "\cf2 ||trim(varnam)||\cf5 " not between 10001 and 9999999999"\cf2 ;                        \par
  else if maxval = \cf5 "nuts"\cf2  then do;\par
    txt2 = \cf5 "where (not exists (select nutscode from nuts where "\cf2 ||trim(varnam)||\cf5 " =nutscode) and "\cf2 ||trim(varnam)||\cf5 " not = """")"\cf2 ;       \par
    txt2f = \cf5 "where ("\cf2 ||trim(varnam)||\cf5 "_F not in "\cf2 ||trim(flag)||\cf5 ")"\cf2 ;\par
    txt3 = \cf5 "where ("\cf2 ||trim(varnam)||\cf5 " not = """" and "\cf2 ||trim(varnam)||\cf5 "_F ne . and "\cf2 ||trim(varnam)||\cf5 "_F < 0) or ("\cf2 ||trim(varnam)||\cf5 " = """" and "\cf2 ||trim(varnam)||\cf5 "_F ge 0)"\cf2 ;\par
    end;  \par
  else if maxval = \cf5 "list"\cf2  then\par
    if index(formt,\cf5 "$"\cf2 ) then do;\par
      txt2 = \cf5 "where ("\cf2 ||trim(varnam)||\cf5 " not in "\cf2 ||trim(minval)||\cf5 " and "\cf2 ||trim(varnam)||\cf5 " not = """")"\cf2 ;\par
      txt2f = \cf5 "where ("\cf2 ||trim(varnam)||\cf5 "_F not in "\cf2 ||trim(flag)||\cf5 ")"\cf2 ;\par
      txt20f = \cf5 "and ("\cf2 ||trim(varnam)||\cf5 "_F not = .)"\cf2 ;\par
      txt3 = \cf5 "where ("\cf2 ||trim(varnam)||\cf5 " not = """" and "\cf2 ||trim(varnam)||\cf5 "_F ne . and "\cf2 ||trim(varnam)||\cf5 "_F < 0) or ("\cf2 ||trim(varnam)||\cf5 " = """" and "\cf2 ||trim(varnam)||\cf5 "_F ge 0)"\cf2 ;\par
      end;\par
    else do;\par
      txt2 = \cf5 "where ("\cf2 ||trim(varnam)||\cf5 " not in "\cf2 ||trim(minval)||\cf5 " and "\cf2 ||trim(varnam)||\cf5 " not = .)"\cf2 ;\par
      txt2f = \cf5 "where ("\cf2 ||trim(varnam)||\cf5 "_F not in "\cf2 ||trim(flag)||\cf5 ")"\cf2 ;\par
      txt20f = \cf5 "and ("\cf2 ||trim(varnam)||\cf5 "_F not = .)"\cf2 ;\par
      txt3 = \cf5 "where ("\cf2 ||trim(varnam)||\cf5 " not = . and "\cf2 ||trim(varnam)||\cf5 "_F ne . and "\cf2 ||trim(varnam)||\cf5 "_F < 0) or ("\cf2 ||trim(varnam)||\cf5 " = . and "\cf2 ||trim(varnam)||\cf5 "_F ge 0)"\cf2 ;\par
      end;\par
  else do;\par
      txt2 = \cf5 "where ("\cf2 ||trim(varnam)||\cf5 " not between "\cf2 ||trim(minval)||\cf5 " and "\cf2 ||trim(maxval)||\cf5 " and "\cf2 ||trim(varnam)||\cf5 " not = .)"\cf2 ;\par
      txt2f = \cf5 "where ("\cf2 ||trim(varnam)||\cf5 "_F not in "\cf2 ||trim(flag)||\cf5 ")"\cf2 ;\par
      txt20f = \cf5 "and ("\cf2 ||trim(varnam)||\cf5 "_F not = .)"\cf2 ;\par
      txt3 = \cf5 "where ("\cf2 ||trim(varnam)||\cf5 " not = . and "\cf2 ||trim(varnam)||\cf5 "_F ne . and "\cf2 ||trim(varnam)||\cf5 "_F < 0) or ("\cf2 ||trim(varnam)||\cf5 " = . and "\cf2 ||trim(varnam)||\cf5 "_F ge 0)"\cf2 ;\par
      txt30 = \cf5 " or ("\cf2 ||trim(varnam)||\cf5 " not = 0 and "\cf2 ||trim(varnam)||\cf5 "_F = 0) or ("\cf2 ||trim(varnam)||\cf5 " = 0 and "\cf2 ||trim(varnam)||\cf5 "_F ne 0)"\cf2 ;\par
      end;\par
  if conditio not = \cf5 ""\cf2  then do;\par
    txt4 = \cf5 "select &f.B010 ""Year"", &f.B030 ""&id"", "\cf2 ||trim(varnam)||\cf5 ", "\cf2 ||trim(varnam)||\cf5 "_F, "\cf2 ||trim(disp)||\cf5 " from dds.&ss%nrstr(&cc).&yy&f"\cf2 ;\par
    txt5 = \cf5 "where "\cf2 ||trim(varnam)||\cf5 "_F ne -3 and (("\cf2 ||trim(conditio)||\cf5 " and "\cf2 ||trim(varnam)||\cf5 "_F ne -2) or not ("\cf2 ||trim(conditio)||\cf5 " or "\cf2 ||trim(varnam)||\cf5 "_F ne -2))"\cf2 ;\par
    end;\par
\par
  put \cf5 "title5;"\cf2 ;\par
  put \cf5 "title3 '%upcase("\cf2  varnam \cf5 ")- "\cf2  labl \cf5 "';"\cf2 ;\par
  put \cf5 "title4 'Syntax check: invalid values';"\cf2 ;\par
  put \cf5 "PROC SQL;"\cf2 ;\par
  put \cf5 "Create table tempo as"\cf2 ;\par
  put txt1;\par
  put txt2;\par
  put \cf5 "order by &f.B030,&f.B010;"\cf2 ;\par
  put \cf5 "Select * from tempo(obs=%nrstr(&errmax));"\cf2 ;\tab           \par
  put \cf5 "Insert into errtab&f set varnam = '"\cf2  varnam \cf5 "', vval = 1, error = (select count(*) from tempo);"\cf2 ;\par
  put \cf5 "QUIT;"\cf2 ;\par
  put \cf5 " "\cf2 ;\par
  if maxval not in (\cf5 "year"\cf2 ,\cf5 "country"\cf2 ,\cf5 "hid"\cf2 ,\cf5 "pid"\cf2 ) then do;\par
    put \cf5 "title4 'Syntax check: invalid flags';"\cf2 ;\par
    put \cf5 "PROC SQL;"\cf2 ;\par
    put \cf5 "Create table tempo as"\cf2 ;\par
    put txt1;\par
    put txt2f;\par
\tab if not req then put txt20f;\par
    put \cf5 "order by &f.B030,&f.B010;"\cf2 ;\par
    put \cf5 "Select * from tempo(obs=%nrstr(&errmax));"\cf2 ;\tab           \par
    put \cf5 "Insert into errtab&f set varnam = '"\cf2  varnam \cf5 "', fval = 1, error = (select count(*) from tempo);"\cf2 ;\par
    put \cf5 "QUIT;"\cf2 ;\par
    put \cf5 " "\cf2 ;\par
\par
    put \cf5 "title4 'Syntax check: value and flag incompatible';"\cf2 ;\par
    put \cf5 "PROC SQL;"\cf2 ;\par
    put \cf5 "Create table tempo as"\cf2 ;\par
    put txt1;\par
    put txt3;\par
\tab if upcase(substr(varnam,\cf6\b 2\cf2\b0 ,\cf6\b 1\cf2\b0 )) = \cf5 "Y"\cf2  then put txt30;\par
    put \cf5 "order by &f.B030,&f.B010;"\cf2 ;\par
    put \cf5 "Select * from tempo(obs=%nrstr(&errmax));"\cf2 ;\tab           \par
    put \cf5 "Insert into errtab&f set varnam = '"\cf2  varnam \cf5 "', flag = 1, error = (select count(*) from tempo);"\cf2 ;\par
    put \cf5 "QUIT;"\cf2 ;\par
    put \cf5 " "\cf2 ;\par
    end;\par
  if conditio not = \cf5 ""\cf2  and req then do;\par
  if varnam = \cf5 "PL120"\cf2  then do;\par
  \tab\cf3 %include\cf2  pl120r;\par
  end;\par
  else do;\tab\par
  \tab if length(conditio) > \cf6\b 32\cf2\b0  then do;\par
\tab   conditio2 = substr(conditio,\cf6\b 25\cf2\b0 );\par
\tab   sp = index(conditio2,\cf5 ' '\cf2 );\par
\tab   conditio2 = substr(conditio2,sp+\cf6\b 1\cf2\b0 );\par
\tab   conditio = substr(conditio,\cf6\b 1\cf2\b0 ,\cf6\b 24\cf2\b0 +sp);\par
    put \cf5 "title4 'Routing check: flag value must be -2 (only) if "\cf2  conditio \cf5 "';"\cf2 ;\par
    put \cf5 "title5 '"\cf2  conditio2 \cf5 "';"\cf2 ;\par
    end;\par
    else put \cf5 "title4 'Routing check: flag value must be -2 (only) if "\cf2  conditio \cf5 "';"\cf2 ;\par
    put \cf5 "PROC SQL;"\cf2 ;\par
    put \cf5 "Create table tempo as"\cf2 ;\par
    put txt4;\par
    put txt5;\par
    put \cf5 "order by &f.B030,&f.B010;"\cf2 ;\par
    put \cf5 "Select * from tempo(obs=%nrstr(&errmax));"\cf2 ;\tab           \par
    put \cf5 "Insert into errtab&f set varnam = '"\cf2  varnam \cf5 "', routing = 1, error = (select count(*) from tempo);"\cf2 ;\par
    put \cf5 "QUIT;"\cf2 ;\par
    put \cf5 " "\cf2 ;\par
\tab end;\par
    end;\par
\par
  if &yy>\cf6\b 07\cf2\b0  and index(flag,\cf5 "-1"\cf2 ) then do;\par
    if substr(varnam,\cf6\b 2\cf2\b0 ,\cf6\b 1\cf2\b0 ) = \cf5 "Y"\cf2  then vpc = \cf6\b 2\cf2\b0 ;\par
\tab else vpc = \cf6\b 5\cf2\b0 ;\par
\tab put \cf5 "title4 'Missing values check: over "\cf2  vpc \cf5 "% of missing values ! ';"\cf2 ;\par
    put \cf5 "PROC SQL;"\cf2 ;\par
\tab txt1 = \cf5 "CREATE TABLE tempo00 AS SELECT &f.B010, (CASE WHEN "\cf2 ||trim(varnam)||\cf5 "_F = -1 THEN 0 WHEN "\cf2 ||trim(varnam)||\cf5 "_F >= 0 THEN 1 END ) AS calcmiss  from &ss%nrstr(&cc).&yy&f ORDER BY &f.B010;"\cf2 ;\par
\tab put txt1;\par
    put \cf5 "QUIT;"\cf2 ;\par
\par
\tab put \cf5 "PROC FREQ DATA=tempo00 noprint; TABLES calcmiss / NOCUM OUT=tempo0; BY &f.B010; RUN;"\cf2 ;\par
\par
    put \cf5 "PROC SQL;"\cf2 ;\par
\tab put \cf5 "Create table tempo as"\cf2 ;\par
\tab put \cf5 "select &f.B010 ""Year"", count ""N missing"", percent ""% of missing values"" format=3.0"\cf2 ;\par
\tab put \cf5 "FROM tempo0"\cf2 ;\par
\tab put \cf5 "where percent > "\cf2  vpc \cf5 " and calcmiss = 0"\cf2 ;\par
    put \cf5 "order by &f.B010;"\cf2 ;\par
    put \cf5 "Select * from tempo(obs=%nrstr(&errmax));"\cf2 ;\tab           \par
    put \cf5 "Insert into errtab&f set varnam = '"\cf2  varnam \cf5 "',missng = 1, error = (select max(percent) from tempo);"\cf2 ;\par
    put \cf5 "QUIT;"\cf2 ;\par
  end;\tab\par
put \cf5 "*----------------------------------------------------------------;"\cf2 ;\par
end;\par
RUN;\par
\cf4\b %MEND\cf2\b0  sntx;\par
\par
\cf4\b %MACRO\cf2\b0  \b\i lgcl\b0\i0 ;\par
filename chkplist \cf5 "&eusilc/pgm/&ss&yy.chkl.0sas"\cf2  ;         \cf1 *** macros to run with params;\cf2\par
filename parpfile \cf5 "&csv/checks 20&yy/_par&ss&yy._l.csv"\cf2 ;   \cf1 *** checks definitions;\cf2   \par
\par
filename l128 \cf5 "&csv/checks 20&yy/_L128.sql"\cf2 ; \cf1 ***  code #128;\cf2\par
filename l135 \cf5 "&csv/checks 20&yy/_L135.sql"\cf2 ; \cf1 ***  code #135;\cf2\par
\par
\par
DATA _null_; \par
  infile parpfile MISSOVER DSD LRECL=\cf6\b 2048\cf2\b0  firstobs=\cf6\b 2\cf2\b0  ;\par
  format cod \cf6\b 3.\cf2\b0 ;\par
  format tit \cf6 $200.\cf2 ;\par
  format tit2 \cf6 $120.\cf2 ;\par
  format sel \cf6 $200.\cf2 ;\par
  format fr \cf6 $1.\cf2 ;\par
  format jn \cf6 $1.\cf2 ;\par
  format on \cf6 $100.\cf2 ;\par
  format wher \cf6 $250.\cf2 ;\par
  format gr \cf6 $30.\cf2 ;\par
  format hav \cf6 $250.\cf2 ;\par
  input cod tit sel fr jn on wher gr hav;\par
\par
  file chkplist;\par
    length txt1 $\cf6\b 256\cf2\b0 ;\par
    length txt2 $\cf6\b 256\cf2\b0 ;\par
    length txt3 $\cf6\b 256\cf2\b0 ;\par
    length txt4 $\cf6\b 256\cf2\b0 ;\par
\par
  if _N_= \cf6\b 1\cf2\b0  then do;\par
    put \cf5 "PROC SQL;"\cf2 ;\par
  \tab put \cf5 "Create table &ss%nrstr(&cc).&yy.d as select * from dds.&ss%nrstr(&cc).&yy.d ;"\cf2 ;\par
  \tab put \cf5 "Create table &ss%nrstr(&cc).&yy.r as select * from dds.&ss%nrstr(&cc).&yy.r ;"\cf2 ;\par
  \tab put \cf5 "Create table &ss%nrstr(&cc).&yy.h as select * from dds.&ss%nrstr(&cc).&yy.h ;"\cf2 ;\par
  \tab put \cf5 "Create table &ss%nrstr(&cc).&yy.p as select * from dds.&ss%nrstr(&cc).&yy.p ;"\cf2 ;\par
\tab put \cf5 "QUIT;"\cf2 ;\par
\tab put \cf5 "*----------------------------------------------------------------;"\cf2 ;\par
  end;\par
\par
\tab txt1 = \cf5 "select "\cf2 ||trim(sel)||\cf5 " from &ss%nrstr(&cc).&yy"\cf2 ||fr||\cf5 " as a"\cf2 ;\par
\tab if jn ne \cf5 ""\cf2   then\par
\tab   txt2 = \cf5 "left join &ss%nrstr(&cc).&yy"\cf2 ||jn||\cf5 " as b on "\cf2 ||trim(on);\par
\tab if wher ne \cf5 ""\cf2  then\par
\tab   txt3 = \cf5 "where "\cf2 ||trim (wher);\par
\tab if gr ne \cf5 ""\cf2  then\par
\tab   txt4 = \cf5 "group by "\cf2 ||trim(gr)||\cf5 " having "\cf2 ||trim(hav);\par
\tab txt5 = \cf5 "order by "\cf2 ||scan(sel,\cf6\b 2\cf2\b0 ,\cf5 ","\cf2 )||\cf5 ","\cf2 ||scan(sel,\cf6\b 1\cf2\b0 ,\cf5 ","\cf2 );\par
\par
\tab if length(tit) > \cf6\b 120\cf2\b0  then do;\par
\tab   tit2 = substr(tit,\cf6\b 100\cf2\b0 );\par
\tab   sp = index(tit2,\cf5 ' '\cf2 );\par
\tab   tit2 = substr(tit2,sp+\cf6\b 1\cf2\b0 );\par
\tab   tit = substr(tit,\cf6\b 1\cf2\b0 ,\cf6\b 100\cf2\b0 +sp);\par
    end;\par
    else tit2 = \cf5 ""\cf2 ;\par
\par
\tab if cod = \cf6\b 128\cf2\b0  then do;\par
  \tab\tab\cf3 %include\cf2  l128;\par
  \tab end;\par
\tab else if cod = \cf6\b 135\cf2\b0  then do;\par
  \tab\tab\cf3 %include\cf2  l135;\par
  \tab end;\par
\tab else do;\par
\tab     put \cf5 'title1 "Check #'\cf2  cod \cf5 '/ &datum";'\cf2 ;\par
\tab\tab put \cf5 'title2 "&ccnam - &surtyp survey &suryear";'\cf2 ;\par
\tab     put \cf5 'title3 "'\cf2  tit \cf5 '";'\cf2 ;\par
\tab     if tit2 ne \cf5 ""\cf2  then put \cf5 'title4 "'\cf2  tit2 \cf5 '";'\cf2 ;\par
\par
\tab     put \cf5 "PROC SQL;"\cf2 ;\par
\tab\tab put \cf5 "Create table tempo as"\cf2 ;\par
\tab\tab put txt1;\par
\tab\tab if txt2 ne \cf5 ""\cf2  then put txt2;\par
\tab\tab if txt3 ne \cf5 ""\cf2  then put txt3;\par
\tab\tab if txt4 ne \cf5 ""\cf2  then put txt4;\par
\tab     put \cf5 ";"\cf2 ;\par
\tab\tab put \cf5 "Select * from tempo(obs=%nrstr(&errmax)) as a"\cf2 ;\par
   \tab\tab\cf3 %if\cf2  &ss=l \cf3 %then\cf2  put txt5;;\par
   \tab\tab\cf1 *put txt5;\cf2\par
\tab     put \cf5 ";"\cf2 ;\par
\par
\tab\tab put \cf5 'Insert into errtabl set cod = '\cf2  cod \cf5 ', error = (select count(*) from tempo);'\cf2 ;\par
\par
\tab\tab put \cf5 "QUIT;"\cf2 ;\par
\tab end;\par
\tab put \cf5 "*----------------------------------------------------------------;"\cf2 ;\par
RUN;\par
\par
\cf4\b %MEND\cf2\b0  lgcl;\par
\par
%\b\i frmts\b0\i0 (d);\par
%\b\i frmts\b0\i0 (r);\par
%\b\i frmts\b0\i0 (h);\par
%\b\i frmts\b0\i0 (p);\par
%\b\i sntx\b0\i0 (d);\par
%\b\i sntx\b0\i0 (r);\par
%\b\i sntx\b0\i0 (h);\par
%\b\i sntx\b0\i0 (p);\par
%\b\i lgcl\b0\i0 ;\par
\cf0\f1\par
}
 